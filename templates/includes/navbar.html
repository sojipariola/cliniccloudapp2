{% load custom_filters %}
<nav class="accordion-nav">
  <ul class="accordion-menu">
    <li>
      <a href="{% if user.is_authenticated %}/dashboard/{% else %}/{% endif %}"
         class="nav-item {% if user.is_authenticated %}{% if request.path|startswith:'/dashboard/' %}active{% endif %}{% else %}{% if request.path == '/' %}active{% endif %}{% endif %}">
         <span class="icon">ğŸ </span>Home
      </a>
    </li>
    
    <li class="accordion-item {% if request.path|startswith:'/patients/' %}active-section{% endif %}">
      <button class="accordion-toggle {% if request.path|startswith:'/patients/' %}active{% endif %}" type="button">
        <span class="icon">ğŸ‘¥</span>Patients<span class="arrow">â–¼</span>
      </button>
      <ul class="accordion-content {% if request.path|startswith:'/patients/' %}active{% endif %}">
        <li><a href="/patients/" class="accordion-link {% if request.path|startswith:'/patients/' %}active{% endif %}"><span class="icon">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>Patients</a></li>
        {% if recent_patients_sidebar %}
          {% for p in recent_patients_sidebar %}
            <li><a href="/patients/{{ p.id }}/" class="accordion-link"><span class="icon">â±</span>{{ p.first_name }} {{ p.last_name }}</a></li>
          {% endfor %}
        {% endif %}
      </ul>
    </li>
    
    <li class="accordion-item {% if request.path|startswith:'/clinical-records/' or request.path|startswith:'/labs/' or request.path|startswith:'/documents/' or request.path|startswith:'/appointments/' or request.path|startswith:'/referrals/' %}active-section{% endif %}">
      <button class="accordion-toggle {% if request.path|startswith:'/clinical-records/' or request.path|startswith:'/labs/' or request.path|startswith:'/documents/' or request.path|startswith:'/appointments/' or request.path|startswith:'/referrals/' %}active{% endif %}" type="button">
        <span class="icon">ğŸ©º</span>Clinical<span class="arrow">â–¼</span>
      </button>
      <ul class="accordion-content {% if request.path|startswith:'/clinical-records/' or request.path|startswith:'/labs/' or request.path|startswith:'/documents/' or request.path|startswith:'/appointments/' or request.path|startswith:'/referrals/' %}active{% endif %}">
        <li><a href="/clinical-records/" class="accordion-link {% if request.path|startswith:'/clinical-records/' and not request.path|startswith:'/clinical-records/ai-note' and not request.path|startswith:'/clinical-records/clinic-note' %}active{% endif %}"><span class="icon">ğŸ“„</span>Clinical Records</a></li>
        <li><a href="/clinical-records/notes/" class="accordion-link {% if request.path|startswith:'/clinical-records/ai-note' or request.path|startswith:'/clinical-records/clinic-note' %}active{% endif %}"><span class="icon">ğŸ“</span>Notes</a></li>
        <li><a href="/labs/" class="accordion-link {% if request.path|startswith:'/labs/' %}active{% endif %}"><span class="icon">ğŸ§ª</span>Lab Results</a></li>
        <li><a href="/documents/upload/" class="accordion-link {% if request.path|startswith:'/documents/' %}active{% endif %}"><span class="icon">ğŸ“¤</span>Upload Document</a></li>
        <li><a href="/appointments/" class="accordion-link {% if request.path|startswith:'/appointments/' %}active{% endif %}"><span class="icon">ğŸ“…</span>Appointments</a></li>
        <li><a href="/referrals/" class="accordion-link {% if request.path|startswith:'/referrals/' %}active{% endif %}"><span class="icon">ğŸ”—</span>Referrals</a></li>
      </ul>
    </li>
    
    <li class="accordion-item {% if request.path|startswith:'/clinical-records/ai-note' %}active-section{% endif %}">
      <button class="accordion-toggle {% if request.path|startswith:'/clinical-records/ai-note' %}active{% endif %}" type="button">
        <span class="icon">ğŸ¤–</span>AI Features<span class="arrow">â–¼</span>
      </button>
      <ul class="accordion-content {% if request.path|startswith:'/clinical-records/ai-note' %}active{% endif %}">
        <li><a href="/clinical-records/ai-note/" class="accordion-link {% if request.path == '/clinical-records/ai-note/' %}active{% endif %}"><span class="icon">ğŸ“</span>AI Note-Taking</a></li>
      </ul>
    </li>
    
    {% if user.is_authenticated %}
      <li><a href="/billing/" class="nav-item {% if request.path|startswith:'/billing/' %}active{% endif %}"><span class="icon">ğŸ’³</span>Billing</a></li>
      
      {% if user.is_staff or user.is_superuser %}
        <li class="accordion-item admin-section {% if request.path|startswith:'/audit_logs/' or request.path|startswith:'/analytics/' or request.path|startswith:'/admin/' %}active-section{% endif %}">
          <button class="accordion-toggle admin-toggle {% if request.path|startswith:'/audit_logs/' or request.path|startswith:'/analytics/' or request.path|startswith:'/admin/' %}active{% endif %}" type="button">
            <span class="icon">ğŸ©º</span><span style="font-weight:bold;color:#1976d2;">Admin</span><span class="arrow">â–¼</span>
          </button>
          <ul class="accordion-content admin-content {% if request.path|startswith:'/audit_logs/' or request.path|startswith:'/analytics/' or request.path|startswith:'/admin/' %}active{% endif %}">
            <li><a href="/audit_logs/" class="accordion-link {% if request.path|startswith:'/audit_logs/' %}active{% endif %}"><span class="icon">ğŸ©»</span><span style="color:#1976d2;">Audit Logs</span></a></li>
            <li><a href="/analytics/dashboard/" class="accordion-link {% if request.path|startswith:'/analytics/' %}active{% endif %}"><span class="icon">ğŸ“Š</span><span style="color:#388e3c;">Analytics</span></a></li>
            <li><a href="/admin/" class="accordion-link {% if request.path|startswith:'/admin/' %}active{% endif %}"><span class="icon">ğŸ§¬</span><span style="color:#d32f2f;">Django Admin</span></a></li>
          </ul>
        </li>
      {% endif %}
      
      <li class="accordion-item user-section {% if request.path|startswith:'/users/profile' %}active-section{% endif %}">
        <button class="accordion-toggle user-toggle {% if request.path|startswith:'/users/profile' %}active{% endif %}" type="button">
          <span class="icon">ğŸ‘¤</span>{{ user.get_full_name|default:user.username }}<span class="arrow">â–¼</span>
        </button>
        <ul class="accordion-content user-content {% if request.path|startswith:'/users/profile' %}active{% endif %}">
          <li><a href="/users/profile/" class="accordion-link {% if request.path|startswith:'/users/profile' %}active{% endif %}"><span class="icon">ğŸ§‘</span>Profile</a></li>
          <li>
            <form action="{% url 'logout' %}" method="post" class="logout-form">
              {% csrf_token %}
              <button type="submit" class="logout-button"><span class="icon">ğŸšª</span>Logout</button>
            </form>
          </li>
        </ul>
      </li>
    {% else %}
      <li><a href="{% url 'login' %}" class="nav-item {% if request.path == '/accounts/login/' %}active{% endif %}"><span class="icon">ğŸ”‘</span>Login</a></li>
      <li><a href="{% url 'register' %}" class="nav-item {% if request.path == '/accounts/register/' %}active{% endif %}"><span class="icon">ğŸ“</span>Register</a></li>
    {% endif %}
  </ul>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const accordionToggles = document.querySelectorAll('.accordion-toggle');
      const accordionNav = document.querySelector('.accordion-nav');
      const accordionItems = document.querySelectorAll('.accordion-item');

      // Assign ARIA attributes and IDs for accessibility
      accordionItems.forEach((item, idx) => {
        const toggle = item.querySelector('.accordion-toggle');
        const content = item.querySelector('.accordion-content');
        const contentId = `accordion-content-${idx}`;
        content.id = contentId;
        toggle.setAttribute('aria-controls', contentId);
        toggle.setAttribute('aria-expanded', content.classList.contains('active') ? 'true' : 'false');
        toggle.setAttribute('role', 'button');
      });
      
      accordionToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          
          const parent = this.closest('.accordion-item');
          const content = parent.querySelector('.accordion-content');
          const arrow = this.querySelector('.arrow');
          
          // Close other accordion items (except if they have active-section class)
          accordionItems.forEach(item => {
            if (item !== parent && !item.classList.contains('active-section')) {
              const otherContent = item.querySelector('.accordion-content');
              const otherArrow = item.querySelector('.arrow');
              otherContent.classList.remove('active');
              otherArrow.style.transform = 'rotateZ(0deg)';
              const otherToggle = item.querySelector('.accordion-toggle');
              if (otherToggle) otherToggle.setAttribute('aria-expanded', 'false');
            }
          });
          
          // Toggle current item
          content.classList.toggle('active');
          if (content.classList.contains('active')) {
            arrow.style.transform = 'rotateZ(180deg)';
            this.setAttribute('aria-expanded', 'true');
          } else {
            arrow.style.transform = 'rotateZ(0deg)';
            this.setAttribute('aria-expanded', 'false');
          }
        });

        // Keyboard accessibility: Enter/Space triggers toggle
        toggle.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
          }
        });
      });
      
      // Auto-expand active sections on page load
      const activeSections = document.querySelectorAll('.accordion-item.active-section');
      activeSections.forEach(section => {
        const content = section.querySelector('.accordion-content');
        const arrow = section.querySelector('.arrow');
        content.classList.add('active');
        arrow.style.transform = 'rotateZ(180deg)';
        const toggle = section.querySelector('.accordion-toggle');
        if (toggle) toggle.setAttribute('aria-expanded', 'true');
      });

      // Close open accordions when clicking outside the nav
      document.addEventListener('click', function(e) {
        if (!accordionNav.contains(e.target)) {
          accordionItems.forEach(item => {
            if (!item.classList.contains('active-section')) {
              const content = item.querySelector('.accordion-content');
              const arrow = item.querySelector('.arrow');
              const toggle = item.querySelector('.accordion-toggle');
              content.classList.remove('active');
              if (arrow) arrow.style.transform = 'rotateZ(0deg)';
              if (toggle) toggle.setAttribute('aria-expanded', 'false');
            }
          });
        }
      });
    });
  </script>
  
  <link rel="stylesheet" href="/static/css/navbar_worldclass.css">
</nav>
