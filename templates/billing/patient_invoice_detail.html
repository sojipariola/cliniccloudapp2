{% extends 'base/base.html' %}
{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div style="max-width:900px; margin:0 auto; padding:1.5rem;">
  {% with patient=invoice.patient %}
    {% include 'includes/patient_header.html' %}
  {% endwith %}
  
  <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:2rem;">
    <div>
      <h1 style="margin:0; font-size:2rem; color:#0f4c81;">Invoice {{ invoice.invoice_number }}</h1>
    </div>
    <div style="text-align:right;">
      <span style="display:inline-block; background:{% if invoice.status == 'paid' %}#d1fae5{% elif invoice.status == 'overdue' %}#fee2e2{% elif invoice.status == 'draft' %}#f3f4f6{% else %}#dbeafe{% endif %}; color:{% if invoice.status == 'paid' %}#065f46{% elif invoice.status == 'overdue' %}#7f1d1d{% elif invoice.status == 'draft' %}#374151{% else %}#1e40af{% endif %}; padding:0.5rem 1rem; border-radius:20px; font-weight:600; font-size:0.9rem;">
        {{ invoice.get_status_display }}
      </span>
    </div>
  </div>

  <!-- Invoice Details -->
  <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:1.5rem; margin-bottom:2rem;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem;">
      <div>
        <h3 style="margin:0 0 0.5rem; color:#0f4c81; font-size:0.9rem; font-weight:700; text-transform:uppercase;">Invoice Details</h3>
        <p style="margin:0; color:#666;"><strong>Issued:</strong> {{ invoice.issued_date|date:"M d, Y" }}</p>
        <p style="margin:0.25rem 0 0; color:#666;"><strong>Due:</strong> {{ invoice.due_date|date:"M d, Y" }}</p>
        {% if invoice.paid_date %}
          <p style="margin:0.25rem 0 0; color:#666;"><strong>Paid:</strong> {{ invoice.paid_date|date:"M d, Y" }}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Line Items -->
  <div style="background:#fff; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; margin-bottom:2rem;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#e5e7eb;">
          <th style="padding:12px; text-align:left; font-weight:700; color:#0f172a;">Description</th>
          <th style="padding:12px; text-align:center; font-weight:700; color:#0f172a;">Type</th>
          <th style="padding:12px; text-align:right; font-weight:700; color:#0f172a;">Qty</th>
          <th style="padding:12px; text-align:right; font-weight:700; color:#0f172a;">Unit Price</th>
          <th style="padding:12px; text-align:right; font-weight:700; color:#0f172a;">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
          <tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:12px; color:#0f172a;">{{ item.description }}</td>
            <td style="padding:12px; text-align:center; color:#666; font-size:0.9rem;">{{ item.get_service_type_display }}</td>
            <td style="padding:12px; text-align:right; color:#666;">{{ item.quantity }}</td>
            <td style="padding:12px; text-align:right; color:#666;">£{{ item.unit_price }}</td>
            <td style="padding:12px; text-align:right; font-weight:600; color:#0f4c81;">£{{ item.total }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Totals -->
  <div style="display:flex; justify-content:flex-end; margin-bottom:2rem;">
    <div style="width:300px;">
      <div style="display:flex; justify-content:space-between; padding:0.75rem 0; border-bottom:1px solid #e5e7eb;">
        <span>Subtotal:</span>
        <span>£{{ invoice.subtotal }}</span>
      </div>
      <div style="display:flex; justify-content:space-between; padding:0.75rem 0; border-bottom:1px solid #e5e7eb;">
        <span>Tax:</span>
        <span>£{{ invoice.tax }}</span>
      </div>
      <div style="display:flex; justify-content:space-between; padding:0.75rem 0; font-size:1.2rem; font-weight:700; color:#0f4c81;">
        <span>Total:</span>
        <span>£{{ invoice.total }}</span>
      </div>
    </div>
  </div>

  <!-- Notes -->
  {% if invoice.notes %}
    <div style="background:#f0f8ff; border:1px solid #bfdbfe; border-radius:8px; padding:1rem; margin-bottom:2rem;">
      <h4 style="margin:0 0 0.5rem; color:#0f4c81;">Notes</h4>
      <p style="margin:0; color:#666; white-space:pre-wrap;">{{ invoice.notes }}</p>
    </div>
  {% endif %}

  <!-- Actions -->
  <div style="display:flex; gap:1rem; justify-content:flex-end;">
    {% if invoice.status != 'paid' and perms.billing.change_patientinvoice %}
      <form method="post" action="{% url 'patient_invoice_mark_paid' invoice.pk %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" style="background:#10b981; color:#fff; border:none; padding:0.6rem 1.2rem; border-radius:6px; font-weight:600; cursor:pointer;">
          ✓ Mark as Paid
        </button>
      </form>
    {% endif %}
    <a href="{% url 'patient_billing' invoice.patient.pk %}" style="background:#e5e7eb; color:#0f4c81; padding:0.6rem 1.2rem; border-radius:6px; text-decoration:none; font-weight:600;">
      Back to Billing
    </a>
  </div>
</div>
{% endblock %}
